<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Stock Agent Notifications</title>

        <!-- HTMX -->
        <script src="https://unpkg.com/htmx.org@1.9.6"></script>
        <style>
            .header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 1px solid #eee;
            }
            .user-info {
                font-size: 14px;
                color: #666;
            }
            .logout-btn {
                background-color: #dc3545;
                color: white;
                border: none;
                padding: 5px 10px;
                border-radius: 3px;
                cursor: pointer;
                font-size: 12px;
                margin-left: 10px;
            }
            .logout-btn:hover {
                background-color: #c82333;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>Stock Agent Notifications</h1>
                {% if user %}
                <div class="user-info">
                    Welcome, {{ user.username }}! 
                    <form method="post" action="/logout" style="display: inline;">
                        <button type="submit" class="logout-btn">Logout</button>
                    </form>
                </div>
                {% endif %}
            </div>
            <div id="notification-status">
                Checking notification permission...
            </div>
            <button id="enable-notifications" style="display: none">
                Enable Push Notifications
            </button>

            <div
                id="topic-subscription"
                style="display: none; margin-top: 20px"
            >
                <h3>Notification Preferences</h3>
                <div>
                    <input
                        type="checkbox"
                        id="gainers-topic"
                        name="gainers-topic"
                    />
                    <label for="gainers-topic">Top Gainers Alerts</label>
                </div>
                <div>
                    <input
                        type="checkbox"
                        id="losers-topic"
                        name="losers-topic"
                    />
                    <label for="losers-topic">Top Losers Alerts</label>
                </div>
            </div>
        </div>

        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
            import {
                getMessaging,
                getToken,
                onMessage,
            } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-messaging.js";

            // Singleton class for Firebase messaging
            class FirebaseMessagingSingleton {
                constructor() {
                    this.app = null;
                    this.messaging = null;
                    this.isInitializing = false;
                }

                async initialize() {
                    // Prevent multiple concurrent initializations
                    if (this.messaging) return this.messaging;
                    if (this.isInitializing) {
                        // Wait for ongoing initialization
                        while (this.isInitializing) {
                            await new Promise((resolve) =>
                                setTimeout(resolve, 100),
                            );
                        }
                        return this.messaging;
                    }

                    this.isInitializing = true;

                    try {
                        // Fetch Firebase configuration
                        const firebaseConfig = await this.fetchFirebaseConfig();

                        // Initialize Firebase with fetched config
                        this.app = initializeApp(firebaseConfig);

                        // Initialize Firebase Cloud Messaging
                        this.messaging = getMessaging(this.app);

                        this.isInitializing = false;
                        return this.messaging;
                    } catch (error) {
                        this.isInitializing = false;
                        console.error("Failed to initialize Firebase:", error);
                        throw error;
                    }
                }

                async fetchFirebaseConfig() {
                    try {
                        const response = await fetch("/api/firebase-config");
                        if (!response.ok) {
                            throw new Error(
                                "Failed to fetch Firebase configuration",
                            );
                        }
                        return await response.json();
                    } catch (error) {
                        console.error(
                            "Error fetching Firebase configuration:",
                            error,
                        );
                        throw error;
                    }
                }

                async getVapidPublicKey() {
                    try {
                        const response = await fetch("/api/vapid-public-key");
                        if (!response.ok) {
                            throw new Error("Failed to fetch VAPID public key");
                        }
                        const data = await response.json();
                        return data.vapidPublicKey;
                    } catch (error) {
                        console.error(
                            "Error fetching VAPID public key:",
                            error,
                        );
                        throw error;
                    }
                }
            }

            // Create a single instance of the Firebase messaging singleton
            const firebaseMessaging = new FirebaseMessagingSingleton();

            // Topic subscription handler
            async function handleTopicSubscription(topic, subscribed) {
                try {
                    const messaging = await firebaseMessaging.initialize();
                    const currentToken = await getToken(messaging);

                    if (!currentToken) {
                        console.error("No registration token available");
                        return;
                    }

                    const endpoint = subscribed
                        ? "/api/subscribe-topic"
                        : "/api/unsubscribe-topic";
                    const response = await fetch(endpoint, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            token: currentToken,
                            topic: topic,
                        }),
                    });

                    if (!response.ok) {
                        throw new Error(
                            `Failed to ${subscribed ? "subscribe to" : "unsubscribe from"} topic`,
                        );
                    }

                    console.log(
                        `Successfully ${subscribed ? "subscribed to" : "unsubscribed from"} topic: ${topic}`,
                    );
                } catch (error) {
                    console.error("Error managing topic subscription:", error);
                    // Revert checkbox state on error
                    document.getElementById(`${topic}-topic`).checked =
                        !subscribed;
                }
            }

            // Main initialization function for messaging
            async function initializeFirebaseMessaging() {
                try {
                    const permission = await Notification.requestPermission();
                    if (permission === "granted") {
                        // Initialize Firebase and get messaging instance
                        const messaging = await firebaseMessaging.initialize();

                        // Get the VAPID public key from server
                        const vapidPublicKey =
                            await firebaseMessaging.getVapidPublicKey();

                        // Get the FCM token
                        const currentToken = await getToken(messaging, {
                            vapidKey: vapidPublicKey,
                        });

                        if (currentToken) {
                            // Register token with server
                            const response = await fetch(
                                "/api/register-token",
                                {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: JSON.stringify({
                                        token: currentToken,
                                    }),
                                },
                            );

                            if (!response.ok) {
                                throw new Error("Failed to register token");
                            }

                            document.getElementById(
                                "notification-status",
                            ).textContent =
                                "Notifications enabled! Choose your notification preferences below.";
                            document.getElementById(
                                "topic-subscription",
                            ).style.display = "block";

                            // Get user's current subscriptions
                            const subscriptionsResponse = await fetch(
                                "/api/user-subscriptions",
                                {
                                    headers: {
                                        Authorization: `Bearer ${currentToken}`,
                                    },
                                },
                            );

                            if (subscriptionsResponse.ok) {
                                const subscriptions =
                                    await subscriptionsResponse.json();

                                // Update checkboxes based on current subscriptions
                                if (subscriptions.gainers) {
                                    document.getElementById(
                                        "gainers-topic",
                                    ).checked = true;
                                }
                                if (subscriptions.losers) {
                                    document.getElementById(
                                        "losers-topic",
                                    ).checked = true;
                                }
                            }
                        } else {
                            document.getElementById(
                                "notification-status",
                            ).textContent =
                                "No registration token available. Request permission to generate one.";
                        }
                    } else {
                        document.getElementById(
                            "notification-status",
                        ).textContent =
                            "Notification permission denied. You won't receive updates.";
                        document.getElementById(
                            "enable-notifications",
                        ).style.display = "block";
                    }
                } catch (err) {
                    console.error("Error getting permission or token:", err);
                    document.getElementById("notification-status").textContent =
                        "Error setting up notifications. Please try again later.";
                    document.getElementById(
                        "enable-notifications",
                    ).style.display = "block";
                }
            }

            // Handle incoming messages when the app is in the foreground
            async function setupMessageHandling() {
                try {
                    const messaging = await firebaseMessaging.initialize();

                    onMessage(messaging, (payload) => {
                        console.log("Message received:", payload);

                        // Create and show a notification
                        const notificationTitle = payload.notification.title;
                        const notificationOptions = {
                            body: payload.notification.body,
                            icon: "/static/images/notification-icon.png",
                            data: payload.data,
                        };

                        new Notification(
                            notificationTitle,
                            notificationOptions,
                        );
                    });
                } catch (error) {
                    console.error("Error setting up message handling:", error);
                }
            }

            // Service Worker Registration
            if ("serviceWorker" in navigator) {
                window.addEventListener("load", async () => {
                    try {
                        const registration =
                            await navigator.serviceWorker.register(
                                "/firebase-messaging-sw.js",
                            );

                        console.log("ServiceWorker registration successful");
                    } catch (err) {
                        console.log("ServiceWorker registration failed: ", err);
                    }
                });
            }

            // Initialize when the page loads
            document.addEventListener("DOMContentLoaded", () => {
                // Check if the browser supports notifications
                if (!("Notification" in window)) {
                    document.getElementById("notification-status").textContent =
                        "This browser does not support notifications";
                    return;
                }

                // Handle the enable notifications button
                document
                    .getElementById("enable-notifications")
                    .addEventListener("click", () => {
                        initializeFirebaseMessaging();
                    });

                // Handle topic subscription checkboxes
                document
                    .getElementById("gainers-topic")
                    .addEventListener("change", (e) => {
                        handleTopicSubscription("gainers", e.target.checked);
                    });

                document
                    .getElementById("losers-topic")
                    .addEventListener("change", (e) => {
                        handleTopicSubscription("losers", e.target.checked);
                    });

                // Initial check
                if (Notification.permission === "granted") {
                    initializeFirebaseMessaging();
                    setupMessageHandling();
                } else if (Notification.permission === "denied") {
                    document.getElementById("notification-status").textContent =
                        "Notification permission denied. You won't receive updates.";
                    document.getElementById(
                        "enable-notifications",
                    ).style.display = "block";
                } else {
                    document.getElementById(
                        "enable-notifications",
                    ).style.display = "block";
                }
            });
        </script>
    </body>
</html>
